@using BookingEnginePMS.Models;
@using BookingEnginePMS.Controllers;
@using Newtonsoft.Json;
@{
    ViewBag.Title = "Confirm";
    Layout = "~/Views/Shared/_Layout.cshtml";
    List<string> countries = (List<string>)ViewData["countries"];
    List<TransitionLanguage> transitions = (List<TransitionLanguage>)Session["transitions"];
    Transition transition = new Transition(transitions);
    Hotel hotel = (Hotel)Session["HotelForBooking"];
    List<PaymentMethod_Home> paymentMethods = (List<PaymentMethod_Home>)Session["paymentMethods"];
    if (paymentMethods is null)
    {
        paymentMethods = new List<PaymentMethod_Home>();
    }
    string paymentMethodsJson = JsonConvert.SerializeObject(paymentMethods);
    string transitionJson = JsonConvert.SerializeObject(transition.transitionLanguages);
    string currency = (string)Session["currency"];
}
<link href="~/Content/css/mobile-select-room.css" rel="stylesheet" />
<link href="~/Content/css/Home/confirm.css" rel="stylesheet" />
<script src="~/Content/js/Home/confirm.js"></script>
<style>
    .errorAccept {
        color: red;
        text-decoration: underline;
    }

    #paypal-button {
        width: 250px;
        overflow: hidden;
        display: block;
        text-align: center;
        margin: 0 auto;
        margin-top: 20px;
    }

    .hide-item {
        display: none !IMPORTANT;
    }
</style>
<input type="hidden" id="firstPaymentMethod" value="@paymentMethodsJson" />
<input type="hidden" id="transition" value="@transitionJson" />
<div>
    <div class="mainindex">
        <header>
            @Html.Partial("~/Views/PartialView/pTimeLine.cshtml", transition)
        </header>
        <div class="content-checkavail">
            <div id="header-avail">
                <div id="left-header-avail">
                    @Html.Partial("~/Views/PartialView/pInfoCompany.cshtml", transition)
                </div>
                <div id="right-header-avail">
                    @Html.Partial("~/Views/PartialView/pCurrency.cshtml")
                    @Html.Partial("~/Views/PartialView/pLanguage.cshtml")
                    <div class="change-search">
                        <a ng-click="changeSearch()" style="cursor:pointer">@(transition.Translate(2311, "Change your selection"))</a>
                    </div>
                </div>
            </div>
            <div class="full-width wrap-selectdate">
                <div class="wrap-item-sidebar">
                    <div>
                        <div id="boxDetailRoomBook">
                            @Html.Partial("~/Views/PartialView/pDetailRoomBook.cshtml", transition)
                        </div>
                    </div>
                </div>
                <div class="right-content-b" id="boxDetailItemChoose">
                    <div class="wc-content-b" ng-cloak>
                        <div class="item-list-service" ng-repeat="item in extrabeds track by $index">
                            <div>
                                <div>
                                    <h3 class="title-room">{{item.RoomTypeName}}</h3>
                                </div>
                                <div class="w-item-img">
                                    <img ng-src="{{item.Image}}" />
                                </div>
                                <div class="info-item-service">
                                    <div class="des-rate-offer">
                                        <span>{{item.ExtrabedName}}</span>
                                    </div>
                                    <div class="item-select-service">
                                        <div class="wrap-service">
                                            <div class="add-service">
                                                <select ng-change="GetAmountForVoucher()" ng-model="item.NumberChoose" convert-to-number>
                                                    <option ng-repeat="index in [0,1,2,3]">{{index}}</option>
                                                </select>
                                                <label for="extrabed">
                                                    <strong>
                                                        @if (currency == "VND")
                                                        {
                                                            <span>  {{item.Price | currency:'':'0'}}</span>
                                                        }
                                                        else
                                                        {
                                                            <span> {{item.PriceExchangeRate | currency:'':'2'}}</span>
                                                        }
                                                    </strong> <span class="unit-price">{{::currency}}</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="des-rate-offer">
                                        <p>{{item.Description}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="item-list-service" ng-repeat="item in services track by $index">
                            <div>
                                <h3 class="title-room">{{item.ServiceName}}</h3>
                            </div>
                            <div class="w-item-img">
                                <img ng-src="{{item.Photo}}" />
                            </div>
                            <div class="info-item-service">
                                <div class="item-select-service">
                                    <div class="wrap-service">
                                        <div class="add-service">
                                            <select ng-change="GetAmountForVoucher()" ng-model="item.NumberChoose" convert-to-number>
                                                <option ng-repeat="index in [0,1,2,3,4,5,6,7,8,9,10]">{{index}}</option>
                                            </select>
                                            <label for="extrabed">
                                                <strong>
                                                    @if (currency == "VND")
                                                    {
                                                        <span>  {{item.Price | currency:'':'0'}}</span>
                                                    }
                                                    else
                                                    {
                                                        <span> {{item.PriceExchangeRate | currency:'':'2'}}</span>
                                                    }
                                                </strong> <span class="unit-price">{{::currency}}</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="des-rate-offer">
                                    <p>{{item.Description}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="right-content-b">
                    <div class="wc-content-b">
                        <div>
                            <h4>@(transition.Translate(2314, "Guest Information"))</h4>
                            <div class="item-b-gust-info">
                                <p><span>*</span>@(transition.Translate(2315, "Indicates Required field."))</p>
                            </div>
                            <div class="left-b-gust-info">
                                <div class="item-b-gust-info">
                                    <label class="lb-b-gust-info">
                                        @(transition.Translate(2317, "First Name"))<span class="required-s">*</span>
                                    </label>
                                    <input ng-click="RefreshValidate()" ng-model="guest.FirstName" type="text" class="input-gust-b-info" />
                                    <span id="err_FirstName" class="error">@(transition.Translate(2353, "Value is invalid!"))</span>
                                </div>
                                <div class="item-b-gust-info">
                                    <label class="lb-b-gust-info">
                                        @(transition.Translate(2318, "Last Name"))<span class="required-s">*</span>
                                    </label>
                                    <input ng-click="RefreshValidate()" ng-model="guest.SurName" type="text" class="input-gust-b-info" />
                                    <span id="err_SurName" class="error">@(transition.Translate(2353, "Value is invalid!"))</span>
                                </div>
                                <div class="item-b-gust-info">
                                    <label class="lb-b-gust-info">
                                        Email<span class="required-s">*</span>
                                    </label>
                                    <input ng-model="guest.Email" type="text" class="input-gust-b-info" />
                                    <span id="err_Email" class="error">@(transition.Translate(2353, "Value is invalid!"))</span>
                                </div>
                                <div class="item-b-gust-info">
                                    <label class="lb-b-gust-info">
                                        @(transition.Translate(2319, "Phone Number"))
                                    </label>
                                    <input ng-click="RefreshValidate()" ng-model="guest.Phone" type="text" class="input-gust-b-info" />
                                </div>

                                <div class="item-b-gust-info">
                                    <label class="lb-b-gust-info">@(transition.Translate(2320, "Address"))</label>
                                    <input ng-model="guest.Address" type="text" class="input-gust-b-info" />
                                </div>
                            </div>
                            <div class="right-b-gust-info">
                                <div class="item-b-gust-info">
                                    <label class="lb-b-gust-info">@(transition.Translate(2321, "Country"))</label>
                                    <select class="select-country-gust-b-info" ng-model="guest.Country">
                                        <option value="N/A">N/A</option>
                                        @foreach (string item in countries)
                                        {
                                            <option value="@item">@item</option>
                                        }
                                    </select>
                                </div>
                                <div class="item-b-gust-info">
                                    <label class="lb-b-gust-info">@(transition.Translate(2322, "Arrival with flight"))</label>
                                    <input ng-model="guest.ArrivalFlightDate" type="text" class="input-gust-b-info" />
                                </div>

                                <div class="item-b-gust-info">
                                    <label class="lb-b-gust-info">@(transition.Translate(2323, "Arrival Time"))</label>
                                    <input ng-model="guest.ArrivalFlightTime" type="text" class="input-gust-b-info" />
                                </div>

                                <div class="item-b-gust-info">
                                    <label class="lb-b-gust-info">@(transition.Translate(2324, "Additional request"))</label>
                                    <textarea ng-model="guest.Note" class="textarea-gust-b-info form-control"></textarea>
                                </div>

                            </div>
                            <div style="clear: both;padding-top:  10px;padding-bottom:  10px;">
                                <span style="display: block;width: 100%;border-bottom: 1px dotted #716969;"></span>
                            </div>
                        </div>

                        @if (paymentMethods.Count > 1 || (paymentMethods.Count == 1 && paymentMethods[0].ConfigPaymentMethodId == 18))
                        {
                            <div class="box-payment-all">
                                <div style="width: 49%;">
                                    <label class="lb-b-gust-info">@(transition.Translate(2325, "Payment method"))</label>
                                    <select ng-change="changePaymentMethod()" class="select-country-gust-b-info" ng-model="guest.TypePaymentMethod" convert-to-number>
                                        <option value="-1"> @(transition.Translate(2433, "-- Choose payment method ---"))</option>
                                        @foreach (PaymentMethod_Home item in paymentMethods)
                                        {

                                            if (item.ConfigPaymentMethodId == 15 || item.ConfigPaymentMethodId == 16)
                                            {
                                                if (currency != "VND")
                                                {
                                                    <option ng-if="priceDepositExchangeRate == 0" id="typePaymentMethod_@item.ConfigPaymentMethodId" value="@item.ConfigPaymentMethodId">@item.Name</option>
                                                }
                                                else
                                                {
                                                    <option ng-if="priceDeposit == 0" id="typePaymentMethod_@item.ConfigPaymentMethodId" value="@item.ConfigPaymentMethodId">@item.Name</option>
                                                }


                                            }
                                            else
                                            {
                                                if (currency == "VND")
                                                {
                                                    <option ng-if="priceDeposit != 0" id="typePaymentMethod_@item.ConfigPaymentMethodId" value="@item.ConfigPaymentMethodId">@item.Name</option>
                                                }
                                                else
                                                {
                                                    <option ng-if="priceDepositExchangeRate != 0" id="typePaymentMethod_@item.ConfigPaymentMethodId" value="@item.ConfigPaymentMethodId">@item.Name</option>
                                                }
                                            }

                                        }
                                    </select>
                                </div>
                            </div>
                        }
                        <div style="clear:both">
                            <div>
                                <div class="info-card" ng-if="paymentMethodChoose.RequireCard">
                                    <h4>@(transition.Translate(2326, "Payment Details"))</h4>
                                    <div class="left-b-gust-info">
                                        <div class="item-b-gust-info">
                                            <label class="lb-b-gust-info">
                                                @(transition.Translate(2327, "Name on card"))<span class="required-s">*</span>
                                            </label>
                                            <input ng-click="RefreshValidate()" ng-model="guest.Name" type="text" class="input-gust-b-info" />
                                            <span id="err_Name" class="error">@(transition.Translate(2353, "Value is invalid!"))</span>
                                        </div>
                                        <div class="item-b-gust-info">
                                            <label class="lb-b-gust-info">
                                                @(transition.Translate(2328, "Card Number"))<span class="required-s">*</span>
                                            </label>
                                            <input ng-click="RefreshValidate()" ng-model="guest.Number" type="text" class="input-gust-b-info" />
                                            <span id="err_Number" class="error">@(transition.Translate(2353, "Value is invalid!"))</span>
                                        </div>
                                        <div class="item-b-gust-info">
                                            <label class="lb-b-gust-info">@(transition.Translate(2329, "Expiry Date"))</label>
                                            <select style="padding: 3px;width: 80px;" ng-model="guest.ExpirationMonth" convert-to-number>
                                                <option ng-repeat="index in [1,2,3,4,5,6,7,8,9,10,12]">{{index}}</option>
                                            </select>
                                            <span>/</span>
                                            <select style="padding: 3px;width: 80px;" ng-model="guest.ExpirationYear" convert-to-number>
                                                <option ng-repeat="index in rangeNumber(2018,2040)">{{index}}</option>
                                            </select>
                                        </div>
                                        <div class="item-b-gust-info">
                                            <label class="lb-b-gust-info">
                                                @(transition.Translate(2330, "Security Code")) <span class="required-s">*</span>
                                            </label>
                                            <input ng-click="RefreshValidate()" ng-model="guest.Code" type="password" class="input-gust-b-info" />
                                            <span id="err_Code" class="error">@(transition.Translate(2353, "Value is invalid!"))</span>
                                        </div>
                                    </div>
                                    <div class="right-b-gust-info" style="margin-top: 30px;">
                                        <div class="item-b-gust-info">
                                            <img src="~/FileDefault/image/icon-card.jpg" />
                                        </div>
                                        <div class="item-b-gust-info">
                                            <img src="~/FileDefault/image/RapidSSL_SEAL.gif" style="width: 25%; margin-top: 10px;" />
                                        </div>
                                    </div>
                                </div>
                                <div class="b-submit">
                                    <div style="border: 1px solid #cccccc;padding: 10px;background: #fbfbfb;">
                                        <div style="margin-bottom:20px" ng-bind-html="paymentMethodChoose.Policy">
                                        </div>
                                        <input ng-click="RefreshValidate()" ng-model="acceptPolicy" type="checkbox" name="checkCertify" />
                                        <span id="err_checkCertify">@(transition.Translate(2331, "I have read and agree to the above"))</span>
                                    </div>
                                    <div style="text-align:center">
                                        <button ng-if="guest.TypePaymentMethod != 13 && guest.TypePaymentMethod != 14 && guest.TypePaymentMethod != 18" class="buton-Check-availability" ng-click="Book()">
                                            @(transition.Translate(2333, "Review Reservation"))
                                        </button>
                                        <button ng-if="guest.TypePaymentMethod == 13 || guest.TypePaymentMethod == 14" class="buton-Check-availability" ng-click="Book()">
                                            @(transition.Translate(2334, "Pay"))
                                        </button>
                                        <div class="{{guest.TypePaymentMethod != 18? 'hide-item':''}}" id="paypal-button">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function ShowDetailCondition() {
        var detailInfoRoom = $("#detail-term");
        detailInfoRoom.dialog("open");
    }
    $(document).ready(function () {
        $("#detail-term").dialog(
            {
                autoOpen: false,
                modal: true,
                width: 600,
                title: 'Terms & Conditions'
            });
        $(window).scroll(function () {
            if (window.innerWidth > 1000) {
                var width = $("#boxDetailRoomBook").width();
                var heightFix = $("#boxDetailItemChoose").offset().top;
                var heightWindowScroll = window.pageYOffset;
                if (heightWindowScroll >= heightFix) {
                    $("#boxDetailRoomBook>div").css("position", "fixed");
                    $("#boxDetailRoomBook>div").css("width", width);
                    $("#boxDetailRoomBook>div").css("top", 0);
                }
                else {
                    $("#boxDetailRoomBook>div").removeAttr("style")
                }
            } else {
                $("#boxDetailRoomBook>div").removeAttr("style")
            }
        });
    });
</script>
<script src="https://www.paypalobjects.com/api/checkout.js"></script>
<script>
    var CREATE_PAYMENT_URL = '/Home/CreatePayment';
    var EXECUTE_PAYMENT_URL = '/Home/ExecutePayment';
    paypal.Button.render({
        env: 'production', // Or 'sandbox' production
        style: {
            layout: 'vertical', // horizontal | vertical
            size: 'medium', // medium | large | responsive
            shape: 'rect', // pill | rect
            color: 'gold' // gold | blue | silver | black
        },

        funding: {
            allowed: [paypal.FUNDING.CARD, paypal.FUNDING.CREDIT]
        },
        commit: true, // Show a 'Pay Now' button
        payment: function () {
            return paypal.request.post(CREATE_PAYMENT_URL).then(function (data) {
                return data.id;
            });
        },
        // onAuthorize() is called when the buyer approves the payment
        onAuthorize: function (data, actions) {
            // Set up a url on your server to execute the payment
            var EXECUTE_URL = EXECUTE_PAYMENT_URL;
            // Set up the data you need to pass to your server
            var dataPost = {
                paymentID: data.paymentID,
                payerID: data.payerID
            };
            // Make a call to your server to execute the payment
            return paypal.request.post(EXECUTE_URL, dataPost)
                .then(function (res) {
                    if (res.state == "COMPLETED") {
                        location.href = '/Home/BookSuccess';
                    }
                    else {
                        if (res.result.name == "INSTRUMENT_DECLINED") {
                            actions.restart();
                        }
                        else {
                            alert(res.result.message);
                            location.href = '/Home/BookError';
                        }
                    }
                })
                .catch(function (err) {
                    alert(res.result.message);
                    location.href = '/Home/BookError';
                });
        },
        onCancel: function (data) {
            // location.href = '/Home/BookError';
        },
        onError: function (err) {
            // location.href = '/Home/BookError';
        }
    }, '#paypal-button');
</script>